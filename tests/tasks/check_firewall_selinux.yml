# SPDX-License-Identifier: MIT
---
- name: Check firewall port status (manage - tcp)
  shell: |
    set -euo pipefail
    firewall-cmd --list-ports | grep "{{ item }}/tcp"
  changed_when: false
  loop: "{{ logging_tls_tcp_ports + logging_tcp_ports }}"
  when:
    - logging_manage_firewall | d(true) | bool
    - (logging_tls_tcp_ports + logging_tcp_ports) | d([]) | length > 0

- name: Check firewall port status (manage - udp)
  shell: |
    set -euo pipefail
    firewall-cmd --list-ports | grep "{{ item }}/udp"
  changed_when: false
  loop: "{{ logging_tls_udp_ports + logging_udp_ports }}"
  when:
    - logging_manage_firewall | d(true) | bool
    - (logging_tls_udp_ports + logging_udp_ports) | d([]) | length > 0

- name: Check firewall port status (no manage - tcp)
  shell: |
    set -euo pipefail
    firewall-cmd --list-ports | grep "{{ item }}/tcp"
  register: _result
  failed_when: _result.rc == 0
  changed_when: false
  loop: "{{ logging_tls_tcp_ports + logging_tcp_ports }}"
  when:
    - not logging_manage_firewall | d(true) | bool
    - (logging_tls_tcp_ports + logging_tcp_ports) | d([]) | length > 0

- name: Check firewall port status (no manage - udp)
  shell: |
    set -euo pipefail
    firewall-cmd --list-ports | grep "{{ item }}/udp"
  register: _result
  failed_when: _result.rc == 0
  changed_when: false
  loop: "{{ logging_tls_udp_ports + logging_udp_ports }}"
  when:
    - not logging_manage_firewall | d(true) | bool
    - (logging_tls_udp_ports + logging_udp_ports) | d([]) | length > 0

- name: Check associated selinux ports (manage - tcp)
  shell: |-
    set -euo pipefail
    sudo semanage port -C --list | egrep "syslog.*_port_t" | \
      grep "{{ item }}" | grep "tcp"
  changed_when: false
  loop: "{{ logging_tls_tcp_ports + logging_tcp_ports | d([]) }}"
  when:
    - logging_manage_selinux | d(true) | bool
    - (logging_tls_tcp_ports + logging_tcp_ports) | d([]) | length > 0

- name: Check associated selinux ports (manage - udp)
  shell: |-
    set -euo pipefail
    sudo semanage port -C --list | egrep "syslog.*_port_t" | \
      grep "{{ item }}" | grep "udp"
  changed_when: false
  loop: "{{ logging_tls_udp_ports + logging_udp_ports }}"
  when:
    - logging_manage_selinux | d(true) | bool
    - (logging_tls_udp_ports + logging_udp_ports) | d([]) | length > 0

- name: Check associated selinux ports (no manage - tcp)
  shell: |-
    set -euo pipefail
    sudo semanage port -C --list | egrep "syslog.*_port_t" | \
      grep "{{ item }}" | grep "tcp"
  changed_when: false
  loop: "{{ logging_tls_tcp_ports + logging_tcp_ports }}"
  register: __result
  failed_when: __result.rc == 0
  when:
    - not logging_manage_selinux | d(true) | bool
    - (logging_tls_tcp_ports + logging_tcp_ports) | d([]) | length > 0

- name: Check associated selinux ports (no manage - udp)
  shell: |-
    set -euo pipefail
    sudo semanage port -C --list | egrep "syslog.*_port_t" | \
      grep "{{ item }}" | grep "udp"
  changed_when: false
  loop: "{{ logging_tls_udp_ports + logging_udp_ports }}"
  register: __result
  failed_when: __result.rc == 0
  when:
    - not logging_manage_selinux | d(true) | bool
    - (logging_tls_udp_ports + logging_udp_ports) | d([]) | length > 0
